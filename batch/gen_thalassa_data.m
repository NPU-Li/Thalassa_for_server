function gen_thalassa_data()  
% ============================================================  
% 生成 THALASSA 批处理数据，保证每个任务结果写到自己的目录  
% 这个主函数会批量创建多个任务目录，每个任务包含 input.txt / object.txt 等文件，用 THALASSA 运行仿真。  
% ============================================================  

%clc; %% 清空命令行窗口，便于运行时输出更干净
1
%% ======== 1) 路径设置 ========
outDir      = '/public/home/guojg/thalassa_dir/output_batch2'; %% 批处理生成的总输出目录（根目录）
tmpl_input  = '/public/home/guojg/thalassa_dir/templates/input_template.txt'; %% input.txt 模板路径
tmpl_object = '/public/home/guojg/thalassa_dir/templates/object_template.txt'; %% object.txt 模板路径
2
%% ======== 2) 模板轨道参数行号（基于你的模板） ========
line_MJD  = 4;   %% MJD（历元）所在行号（从 1 开始计数）
line_SMA  = 5;   %% 半长轴 (SMA) 所在行号
line_ECC  = 6;   %% 偏心率 (ECC) 所在行号
line_INC  = 7;   %% 倾角 (INC) 所在行号
line_RAAN = 8;   %% 升交点赤经 (RAAN) 所在行号
line_AOP  = 9;   %% 近地点幅角 (AOP) 所在行号
line_M    = 10;  %% 平近点角 (M) 所在行号
%% 这些行号对应到 object_template.txt 中具体要替换的行位置
3
%% ======== 3) 轨道数据（单位 km / deg） ========
% orbits 数组的每行是一组任务的轨道六根数 [SMA, ECC, INC, RAAN, AOP, M]
% 通常的轨道六根数指的是：半长轴aa、离心率ee、轨道倾角ii、近心点辐角ωω、升交点经度ΩΩ和真近点角φφ。
% orbits = [
%     7577.6  0.001  87.9   3.0    45.2   126.8;
%     9209.8  0.218  106.3  347.2  56.7   255.5;
%     8486.6  0.189  34.7   48.7   224.3  188.5;
%     10434.8 0.313  171.4  327.5  256.3  291.2;
%     7988.8  0.143  57.1   38.4   59.9   142.7;
%     7958.9  0.047  132.2  313.4  316.1  188.3
% ];
% orbits = [
%           7577.60000001061        0.0010000000369227          87.9000000006779           2.9999999999682          45.1999998527718          126.800000322319
%           9251.63679776762         0.227821610241346          106.291806807187          347.353630677572          59.2656642773955          251.524391183035
%           8273.44655133294         0.126735003675476          34.6949215504854          51.1738566360496          232.125682195304          20.7594739338733
%           10465.4578750431          0.31842028429667          171.396802168152          327.395970644402          255.103767618009          140.103157455039
%           8196.10427553028         0.202478696558185          57.0643860493474          37.2017730520636          64.6788525081074          10.5577511165794
%           7951.25888690323         0.050715616782605          132.190553183556          313.182078122604          292.996769340674          69.1694333817394
%           ];
 orbits = [
           7577.60000008244      0.000999999976913037          87.9000000000127          3.00000000003493          45.1999998421907          126.800001089681
            9251.6366397964         0.227821588355307          106.291806861959          347.353630837485          59.2656537341684          251.523375442668
           8273.44656380918          0.12673502182546          34.6949213399883          51.1738541664623          232.125677125198          20.7600098208097
           10465.4578139565         0.318420276611226          171.396802320078          327.395976650469          255.103775344434          140.102743128072
           8196.10422510842         0.202478734754352          57.0643852105944          37.2017642575161          64.6788151838103          10.5611435847122
           7951.25888696479        0.0507156201081185          132.190553200232          313.182078967244          292.996760434422          69.1694500586486
           7577.60000008244      0.000999999976913037          87.9000000000127          3.00000000003493          45.1999998421907          126.800001089681
            9251.6366397964         0.227821588355307          106.291806861959          347.353630837485          59.2656537341684          251.523375442668
           8273.44656380918          0.12673502182546          34.6949213399883          51.1738541664623          232.125677125198          20.7600098208097
           10465.4578139565         0.318420276611226          171.396802320078          327.395976650469          255.103775344434          140.102743128072
           8196.10422510842         0.202478734754352          57.0643852105944          37.2017642575161          64.6788151838103          10.5611435847122
           7951.25888696479        0.0507156201081185          132.190553200232          313.182078967244          292.996760434422          69.1694500586486
           7577.60000008244      0.000999999976913037          87.9000000000127          3.00000000003493          45.1999998421907          126.800001089681
            9251.6366397964         0.227821588355307          106.291806861959          347.353630837485          59.2656537341684          251.523375442668
           8273.44656380918          0.12673502182546          34.6949213399883          51.1738541664623          232.125677125198          20.7600098208097
           10465.4578139565         0.318420276611226          171.396802320078          327.395976650469          255.103775344434          140.102743128072
           8196.10422510842         0.202478734754352          57.0643852105944          37.2017642575161          64.6788151838103          10.5611435847122
           7951.25888696479        0.0507156201081185          132.190553200232          313.182078967244          292.996760434422          69.1694500586486
           7577.60000008244      0.000999999976913037          87.9000000000127          3.00000000003493          45.1999998421907          126.800001089681
            9251.6366397964         0.227821588355307          106.291806861959          347.353630837485          59.2656537341684          251.523375442668
           8273.44656380918          0.12673502182546          34.6949213399883          51.1738541664623          232.125677125198          20.7600098208097
           10465.4578139565         0.318420276611226          171.396802320078          327.395976650469          255.103775344434          140.102743128072
           8196.10422510842         0.202478734754352          57.0643852105944          37.2017642575161          64.6788151838103          10.5611435847122
           7951.25888696479        0.0507156201081185          132.190553200232          313.182078967244          292.996760434422          69.1694500586486
           7577.60000008244      0.000999999976913037          87.9000000000127          3.00000000003493          45.1999998421907          126.800001089681
            9251.6366397964         0.227821588355307          106.291806861959          347.353630837485          59.2656537341684          251.523375442668
           8273.44656380918          0.12673502182546          34.6949213399883          51.1738541664623          232.125677125198          20.7600098208097
           10465.4578139565         0.318420276611226          171.396802320078          327.395976650469          255.103775344434          140.102743128072
           8196.10422510842         0.202478734754352          57.0643852105944          37.2017642575161          64.6788151838103          10.5611435847122
           7951.25888696479        0.0507156201081185          132.190553200232          313.182078967244          292.996760434422          69.1694500586486
           7577.60000008244      0.000999999976913037          87.9000000000127          3.00000000003493          45.1999998421907          126.800001089681
            9251.6366397964         0.227821588355307          106.291806861959          347.353630837485          59.2656537341684          251.523375442668
           8273.44656380918          0.12673502182546          34.6949213399883          51.1738541664623          232.125677125198          20.7600098208097
           10465.4578139565         0.318420276611226          171.396802320078          327.395976650469          255.103775344434          140.102743128072
           8196.10422510842         0.202478734754352          57.0643852105944          37.2017642575161          64.6788151838103          10.5611435847122
           7951.25888696479        0.0507156201081185          132.190553200232          313.182078967244          292.996760434422          69.1694500586486
           7577.60000008244      0.000999999976913037          87.9000000000127          3.00000000003493          45.1999998421907          126.800001089681
            9251.6366397964         0.227821588355307          106.291806861959          347.353630837485          59.2656537341684          251.523375442668
           8273.44656380918          0.12673502182546          34.6949213399883          51.1738541664623          232.125677125198          20.7600098208097
           10465.4578139565         0.318420276611226          171.396802320078          327.395976650469          255.103775344434          140.102743128072
           8196.10422510842         0.202478734754352          57.0643852105944          37.2017642575161          64.6788151838103          10.5611435847122
           7951.25888696479        0.0507156201081185          132.190553200232          313.182078967244          292.996760434422          69.1694500586486
           7577.60000008244      0.000999999976913037          87.9000000000127          3.00000000003493          45.1999998421907          126.800001089681
            9251.6366397964         0.227821588355307          106.291806861959          347.353630837485          59.2656537341684          251.523375442668
           8273.44656380918          0.12673502182546          34.6949213399883          51.1738541664623          232.125677125198          20.7600098208097
           10465.4578139565         0.318420276611226          171.396802320078          327.395976650469          255.103775344434          140.102743128072
           8196.10422510842         0.202478734754352          57.0643852105944          37.2017642575161          64.6788151838103          10.5611435847122
           7951.25888696479        0.0507156201081185          132.190553200232          313.182078967244          292.996760434422          69.1694500586486
           7577.60000008244      0.000999999976913037          87.9000000000127          3.00000000003493          45.1999998421907          126.800001089681
            9251.6366397964         0.227821588355307          106.291806861959          347.353630837485          59.2656537341684          251.523375442668
           8273.44656380918          0.12673502182546          34.6949213399883          51.1738541664623          232.125677125198          20.7600098208097
           10465.4578139565         0.318420276611226          171.396802320078          327.395976650469          255.103775344434          140.102743128072
           8196.10422510842         0.202478734754352          57.0643852105944          37.2017642575161          64.6788151838103          10.5611435847122
           7951.25888696479        0.0507156201081185          132.190553200232          313.182078967244          292.996760434422          69.1694500586486
           7577.60000008244      0.000999999976913037          87.9000000000127          3.00000000003493          45.1999998421907          126.800001089681
            9251.6366397964         0.227821588355307          106.291806861959          347.353630837485          59.2656537341684          251.523375442668
           8273.44656380918          0.12673502182546          34.6949213399883          51.1738541664623          232.125677125198          20.7600098208097
           10465.4578139565         0.318420276611226          171.396802320078          327.395976650469          255.103775344434          140.102743128072
           8196.10422510842         0.202478734754352          57.0643852105944          37.2017642575161          64.6788151838103          10.5611435847122
           7951.25888696479        0.0507156201081185          132.190553200232          313.182078967244          292.996760434422          69.1694500586486
           ];
MJD0 = 5.883400000000000E+04; %% 起始历元（MJD 时间格式）
4
%% ======== 4) 清理并创建输出目录 ========
if exist(outDir,'dir') %% 如果总输出目录已经存在
    rmdir(outDir,'s'); %% 递归删除整个目录及其子文件夹（'s' 表示静默，不询问确认）
end
mkdir(outDir); %% 创建新的空总目录

%% ======== 5) 写 grid.dat ========
write_grid_dat(outDir, MJD0, orbits); %% 调用工具函数，用轨道数据生成 grid.dat 文件

%% ======== 6) 写 griddef.json ========
write_griddef_json(outDir, MJD0, orbits); %% 调用工具函数，用轨道数据生成 griddef.json 配置文件

%% ======== 7) 读取模板 ========
tmplInputLines  = read_lines_keep_order(tmpl_input);  %% 按行读取 input.txt 模板，保留顺序
tmplObjectLines = read_lines_keep_order(tmpl_object); %% 按行读取 object.txt 模板，保留顺序

%% ======== 8) 按轨道数据生成任务文件 ========
chunkSize = 10000; %% 每批任务最大数量
N = size(orbits,1); %% N = 总轨道数（任务数）
numChunks = ceil(N/chunkSize); %% 总批数，向上取整
5
for c = 1:numChunks %% 循环每一批任务
    cDir = fullfile(outDir, sprintf('C%03d', c)); %% 批次目录，例如 C001
    mkdir(cDir); %% 创建此批次目录
    sid0 = (c-1)*chunkSize + 1; %% 当前批次的起始任务 ID
    sid1 = min(c*chunkSize, N); %% 当前批次的结束任务 ID

    for sid = sid0:sid1 %% 循环当前批次内每个任务
        sDir = fullfile(cDir, sprintf('S%010d', sid)); %% 任务目录名，例如 S0000000001
        mkdir(sDir); %% 创建任务目录

        % --- 写 input.txt（修改 out: 路径到当前任务目录的 out 子文件夹）
        linesIn = tmplInputLines; %% 拷贝模板内容
        idxOut = find(~cellfun('isempty', regexp(strtrim(linesIn), '^out\s*:')), 1, 'first'); 
        %% 找到模板中 'out:' 开头的行索引
        outSubdir = fullfile(sDir, 'out'); %% 当前任务输出子目录路径
        if exist(outSubdir,'dir') ~= 7 %% 如果 out 子目录不存在
            mkdir(outSubdir); %% 创建 out 子目录
        end
        if ~isempty(idxOut) %% 如果模板中找到了 out 行
            linesIn{idxOut} = ['out: ', outSubdir]; %% 替换该行为新的任务 out 路径
        else
            linesIn{end+1} = ['out: ', outSubdir]; %% 如果模板没有 out 行，则在结尾添加
        end
        write_lines_explicit_newline(fullfile(sDir,'input.txt'), linesIn); 
        %% 写入新的 input.txt 文件（显式换行为 CRLF）
6
        % --- 写 object.txt (替换轨道参数行) ---
        lines = tmplObjectLines; %% 拷贝 object 模板
        lines{line_MJD}  = sprintf('%22.15E MJD [UTC]', MJD0); %% 替换 MJD 行
        lines{line_SMA}  = sprintf('%22.15E SMA [km]', orbits(sid,1)); %% 替换半长轴行
        lines{line_ECC}  = sprintf('%22.15E ECC [-]', orbits(sid,2));   %% 替换偏心率行
        lines{line_INC}  = sprintf('%22.15E INC [deg]', orbits(sid,3)); %% 替换倾角行
        lines{line_RAAN} = sprintf('%22.15E RAAN [deg]', orbits(sid,4)); %% 替换升交点赤经行
        lines{line_AOP}  = sprintf('%22.15E AOP [deg]', orbits(sid,5)); %% 替换近地点幅角行
        lines{line_M}    = sprintf('%22.15E M [deg]', orbits(sid,6));   %% 替换平近点角行
7
        write_lines_explicit_newline(fullfile(sDir,'object.txt'), lines); %% 写入新的 object.txt
    end
end

fprintf('✅ 已生成：%s', outDir); %% 在命令行显示已完成提示

end %% 主函数结束

%% ===== 工具：写 grid.dat =====
function write_grid_dat(outDir, MJD0, orbits)
gridFile = fullfile(outDir,'grid.dat'); %% grid.dat 路径
fid = fopen(gridFile,'w'); %% 打开文件用于写入
write_line(fid, '# THALASSA GRID FILE'); %% 写文件头注释
write_line(fid, ['# Generated on ', datestr(now,'yyyy-mm-ddTHH:MM:SS')]); %% 写生成时间
write_line(fid, '# Columns: SID, MJD (TT), SMA (km), ECC, INC (deg), RAAN (deg), AOP (deg), M (deg)'); %% 写列说明
for k = 1:size(orbits,1) %% 循环每个轨道
    line = sprintf('%010u, %22.15E, %22.15E, %22.15E, %22.15E, %22.15E, %22.15E, %22.15E', ...
        k, MJD0, orbits(k,1), orbits(k,2), orbits(k,3), orbits(k,4), orbits(k,5), orbits(k,6));
    %% 格式化每一行轨道数据
    write_line(fid, line); %% 写入文件
end
fclose(fid); %% 关闭文件
end

%% ===== 工具：写 griddef.json =====
function write_griddef_json(outDir, MJD0, orbits)
S.Model = struct( ...
    'NS_gravity', struct('Flag', true, 'Degree', 7, 'Order', 7), ... %% 非球形重力场，阶/次=7
    'Drag',       struct('Flag', true, 'Model', 'MSIS00', 'Solar_flux', 'Variable'), ... %% 大气阻力模型 (NRLMSISE-00)
    'Lunisolar',  struct('Sun', true, 'Moon', true, 'Ephemerides', 'DE431'), ... %% 太阳+月球摄动，DE431 历书
    'SRP',        struct('Flag', true, 'Eclipses', true)); %% 光压，考虑地影
S.Spacecraft = struct('Mass',260, 'Drag_area',2.7, 'SRP_area',2.7, 'CD',2.2, 'CR',1.3); %% 航天器物理参数
S.Integration = struct('Tolerance',1e-10, 'Duration', 15.1, 'Step',4.25e-7, 'Equations', 2); %% 积分参数
S.Grid = struct( ... %% 网格范围定义
    'MJD',  struct('start', MJD0, 'end', MJD0, 'points', 1), ...
    'SMA',  struct('start', min(orbits(:,1)), 'end', max(orbits(:,1)), 'points', size(orbits,1)), ...
    'ECC',  struct('start', min(orbits(:,2)), 'end', max(orbits(:,2)), 'points', size(orbits,1)), ...
    'INC',  struct('start', min(orbits(:,3)), 'end', max(orbits(:,3)), 'points', size(orbits,1)), ...
    'RAAN', struct('start', min(orbits(:,4)), 'end', max(orbits(:,4)), 'points', size(orbits,1)), ...
    'AOP',  struct('start', min(orbits(:,5)), 'end', max(orbits(:,5)), 'points', size(orbits,1)), ...
    'MA',   struct('start', min(orbits(:,6)), 'end', max(orbits(:,6)), 'points', size(orbits,1)) ...
);
%txt = jsonencode(S,'PrettyPrint',true); %% 转为 JSON 格式（漂亮缩进）
txt = jsonencode(S);  % 转为 JSON 格式（旧版只能紧凑输出）
fid = fopen(fullfile(outDir,'griddef.json'),'w'); %% 打开写文件
fwrite(fid,txt,'char'); %% 写 JSON 内容
fclose(fid); %% 关闭文件
end

%% ===== 工具：读文件按行存为 cell =====
function lines = read_lines_keep_order(filepath)
fid = fopen(filepath,'r'); %% 打开文件读取
if fid < 0
    error('无法打开模板文件: %s', filepath); %% 如果打开失败抛出错误
end
C = textscan(fid,'%s','Delimiter','\n','Whitespace',''); %% 每行读入一个元素
fclose(fid);
lines = C{1}; %% 返回 cell 数组，每个元素是一行文本
end

%% ===== 工具：逐行写文件（显式换行） =====
function write_lines_explicit_newline(filepath, lines)
fid = fopen(filepath,'w'); %% 打开文件写入
for i = 1:numel(lines) %% 循环每行
    fwrite(fid, lines{i}, 'char'); %% 写行文本
    fwrite(fid, char(10), 'char'); %% 显式写入换行符 LF
end
fclose(fid); %% 关闭文件
end

%% ===== 工具：写单行+换行 =====
function write_line(fid, s)
fwrite(fid, s, 'char'); %% 写字符串
fwrite(fid, char(10), 'char'); %% 换行
end
